- name: Copy Uninstall RDO Script
  become_user: root
  template:
    src: "{{ item }}.j2"
    dest: "/root/rdo-scripts/{{ item }}"
    mode: 0755
  register: copy_uninstall_rdo_script
  ignore_errors: true
  with_items:
    - "uninstall-rdo.sh"
- debug: msg={{ copy_uninstall_rdo_script }}


- name: Run Uninstall RDO Script
  shell: |
    ./uninstall-rdo.sh
  ignore_errors: true
  args:
    chdir: /root/rdo-scripts
    executable: /bin/bash


# 1
- name: Enable SELinux Policy
  import_tasks: enable-selinux.yml


# 2
- name: Enable NetworkManager
  service: name=NetworkManager enabled=yes
  ignore_errors: true


# 3
- name: Disable Sysinit Network
  service: name=network enabled=no
  ignore_errors: true
  # service: name=network state=started enabled=yes


# 4
- name: Delete Sysinit Network Scripts
  become_user: root
  file:
    path: "/etc/sysconfig/network-scripts/{{ item }}"
    state: absent
  register: delete_sysinit_network_scripts
  ignore_errors: true
  with_items:
    - "ifcfg-ens192"
    - "ifcfg-ens224"
    - "ifcfg-ens256"
- debug: msg={{ delete_sysinit_network_scripts }}


# 5
- name: Uninstall Openstack Sysinit Network Scripts
  package:
    name: openstack-network-scripts
    state: absent
  ignore_errors: true
  # name: network-scripts


# 6
- name: Uninstall Openstack Packstack
  package:
    name: "{{ item }}"
    state: present
  ignore_errors: true
  with_items:
    - python3-gpid-proton

# 6
- name: Uninstall Openstack Packstack
  package:
    name: "{{ item }}"
    state: present
  ignore_errors: true
  with_items:
    - leatherman


- name: X
  shell: |
    yum --setopt=tsflags=noscripts remove -y openstack-network-scripts
    yum --setopt=tsflags=noscripts remove -y network-scripts
  ignore_errors: true


# 6
- name: Uninstall Openstack Packstack
  package:
    name: "{{ item }}"
    state: present
  ignore_errors: true
  with_items:
    - openstack-packstack


# 7
# Upgrade packages to latest version
#- name: Update All Packages
#  package: name=* state=latest update_cache=yes


- name: Install Openstack Packstack
  dnf:
    name: "{{ item }}"
    state: present
  ignore_errors: true
  with_items:
    - openstack-selinux
    - python3-openstackclient


# 8
# https://www.rdoproject.org/deliverables/repos/
#- name: Uninstall RDO Repository Package
#  shell: |
#    yum remove -y rdo-release-dalmatian
#  ignore_errors: true


- name: Disable Openstack Repository
  dnf:
    name: "{{ item }}"
    state: absent
  ignore_errors: true
  with_items:
    - centos-release-openstack-bobcat


# 9
#- name: Install Ansible
#  package:
#    name: ansible
#    state: present


# 10
# https://centlinux.com/enable-powertools-repository/
- name: Ensure the CRB Repository is Disable for Rocky Instead of Powertools Provided by Red hat
  shell: dnf config-manager --disable crb
  ignore_errors: true


# 11
- name: Start Firewalld
  service: name=firewalld state=started enabled=no
  ignore_errors: true


# 12
#- name: Configure Language Pack
#  lineinfile:
#    path: /etc/environment
#    line: "{{ item }}"
#    state: present
#  ignore_errors: true
#  with_items:
#    - "LANG=en_US.utf-8"
#    - "LC_ALL=en_US.utf-8"


# 13
#- name: Uninstall Language Pack
#  package: name={{ item }} state=absent
#  ignore_errors: true
#  with_items:
#   - glibc-langpack-en


- name: Reboot Required
  shell: ( /bin/sleep 5; /sbin/shutdown -r now "Ansible updates triggered" ) &
  ignore_errors: true
  register: reboot_required
  async: 120
  poll: 0
  notify:
    - Waiting for Server to Come Back After Reboot


- meta: flush_handlers


# https://gist.github.com/ksingh7/7a9f1f62c06318a17dad


